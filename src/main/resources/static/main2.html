<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 必须的 meta 标签 -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap 的 CSS 文件 -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/soho.min.css">
    <link rel="stylesheet" href="./css/bootstrap-icons.css">
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;

        }

        .chat-body::-webkit-scrollbar {
            display: none;
        }

        body {
            background-color: #6e707a;
        }
    </style>
    <title>主页</title>
</head>
<body style="z-index: 0">
<div class="container-fluid" style="height: 100%">
    <div class="row" style="height: 100%">
        <div id="scene" class="col-10"
             style="height: 100%;background-color: #0091d2;z-index: 5;position: relative;padding: 0;margin: 0;">

            <!--            <div class="float-right"-->
            <!--                 style="z-index: 10;width: 10%;height: 15%;background-color: #6e707a;padding: 0;margin: 0;">-->
            <!--                <ul>-->
            <!--                    <li>x轴</li>-->
            <!--                    <li>y轴</li>-->
            <!--                    <li>z轴</li>-->
            <!--                </ul>-->
            <!--            </div>-->
            <div class="bg-dark"
                 style="position: absolute;bottom:0;width: 100%;z-index: 10;padding: 2px;margin: 0;max-height: 20%">
                <div class="row">

                    <div class="col-3 d-none d-sm-block d-md-block d-xl-none d-lg-none">
                        <!--选择三维物体区域-->
                        <button style="margin: 2px 1px;" class="btn btn-success btn-sm" onclick="addModelOnClick(0)">
                            立方体
                        </button>
                        <button style="margin: 2px 1px;" class="btn btn-success btn-sm" onclick="addModelOnClick(1)">圆
                        </button>
                        <button style="margin: 2px 1px;" class="btn btn-success btn-sm" onclick="addModelOnClick(2)">
                            圆柱体
                        </button>
                        <br>
                        <button style="margin: 2px 1px;" class="btn btn-info btn-sm" onclick="transformOnClick(1)">平移
                        </button>
                        <button style="margin: 2px 1px;" class="btn btn-info btn-sm" onclick="transformOnClick(2)">旋转
                        </button>
                        <button style="margin: 2px 1px;" class="btn btn-info btn-sm" onclick="transformOnClick(3)">缩放
                        </button>
                        <button style="margin: 2px 1px;" class="btn btn-warning btn-sm"
                                onclick="document.location.reload();">重置
                        </button>
                    </div>
                    <!--                    <div class="col-3 d-none d-sm-block d-md-block d-xl-none d-lg-none">-->
                    <!--                        &lt;!&ndash;操作区域&ndash;&gt;-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-info btn-sm" onclick="transformOnClick(1)">平移</button>-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-info btn-sm" onclick="transformOnClick(2)">旋转</button>-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-info btn-sm" onclick="transformOnClick(3)">缩放</button>-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-warning btn-sm" onclick="document.location.reload();">重置</button>-->
                    <!--                    </div>-->
                    <div class="col-3 d-block d-sm-none d-md-none d-lg-block d-xl-block">
                        <!--选择三维物体区域-->
                        <button style="margin: 2px 1px;" class="btn btn-success " onclick="addModelOnClick(0)">立方体
                        </button>
                        <button style="margin: 2px 1px;" class="btn btn-success " onclick="addModelOnClick(1)">圆
                        </button>
                        <button style="margin: 2px 1px;" class="btn btn-success " onclick="addModelOnClick(2)">圆柱体
                        </button>
                        <br>
                        <button style="margin: 2px 1px;" class="btn btn-info " onclick="transformOnClick(1)">平移</button>
                        <button style="margin: 2px 1px;" class="btn btn-info " onclick="transformOnClick(2)">旋转</button>
                        <button style="margin: 2px 1px;" class="btn btn-info " onclick="transformOnClick(3)">缩放</button>
                        <button style="margin: 2px 1px;" class="btn btn-warning " onclick="document.location.reload();">
                            重置
                        </button>
                    </div>
                    <!--                    <div class="col-3 d-block d-sm-none d-md-none d-lg-block d-xl-block">-->
                    <!--                        &lt;!&ndash;操作区域&ndash;&gt;-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-info " onclick="transformOnClick(1)">平移</button>-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-info " onclick="transformOnClick(2)">旋转</button>-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-info " onclick="transformOnClick(3)">缩放</button>-->
                    <!--                        <button style="margin: 2px 1px;" class="btn btn-warning " onclick="document.location.reload();">重置</button>-->
                    <!--                    </div>-->
                    <div class="col-3">
                        <ul class="list-group" style="color: white">
                            <li class="list-group-item">位置：X:
                                <span style="margin: 0 10px 0 0" id="px"></span> Y:
                                <span style="margin: 0 10px 0 0" id="py"></span> Z:
                                <span style="margin: 0 10px 0 0" id="pz"></span>
                            </li>
                            <li class="list-group-item">旋转：X:<span style="margin: 0 10px 0 0" id="rx"></span> Y:<span
                                    style="margin: 0 10px 0 0" id="ry"></span> Z:<span style="margin: 0 10px 0 0"
                                                                                       id="rz"></span></li>
                            <li class="list-group-item">缩放：X:<span style="margin: 0 10px 0 0" id="sx"></span> Y:<span
                                    style="margin: 0 10px 0 0" id="sy"></span> Z:<span style="margin: 0 10px 0 0"
                                                                                       id="sz"></span></li>
                        </ul>
                    </div>

                    <div class="col-6">
                        <div style="float:right;position:absolute;right:10px;padding: 0;margin: 0 ">
                            <button class="btn btn-info" onclick="window.open('img.html')">在新窗口打开</button>
                        </div>
                        <iframe id="iframe" frameborder="0" src="img.html" width="100%"></iframe>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-2 bg-light" style="height: 100%;background-color: #b3d7ff;z-index: 5">
            <div class="layout">
                <div class="content ">
                    <div class="chat">
                        <div class="chat-body" style="outline: none;overflow-y:auto">
                            <div id="messages" class="messages">

                            </div>
                            <span id="msg_end" style="overflow:hidden"></span>
                        </div>
                        <div class="chat-footer">
                            <div class="input-group">
                                <input id="pltext" type="text" class="form-control" placeholder=""
                                       aria-label=""
                                       aria-describedby="button-addon4">
                                <div class="input-group-append" id="button-addon4">
                                    <button class="btn btn-outline-secondary btn-success" style="color: white"
                                            onclick="sendMsg()">发送
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./js/jquery-3.6.0.min.js"></script>
<script src="./js/bootstrap.bundle.min.js"></script>
<script src="./js/bootstrap.min.js"></script>
<script src="./js/three.js"></script>
<script src="./js/DragControls.js"></script>
<script src="./js/stats.min.js"></script>
<script src="./js/Detector.js"></script>
<script src="./js/TrackballControls.js"></script>
<script src="./js/dat.gui.min.js"></script>
<script src="./js/TransformControls.js"></script>
<script>
    let sceneDiv = $('#scene')
    let user = JSON.parse(sessionStorage.getItem("user"))
    let msgList = []
    let model = {};
    let models = []
    let tr = false
    let ro = false
    let sc = false

    const stats = initStats();
    let scene, camera, renderer, controls, light, selectObject, transformControls, dragControls;

    setInterval(getMsg, 3000)

    // 场景
    function initScene() {
        scene = new THREE.Scene();
    }

    // 相机
    function initCamera() {
        camera = new THREE.PerspectiveCamera(45, sceneDiv.width() / sceneDiv.height(), 0.1, 10000);
        camera.position.set(0, 400, 600);
        camera.lookAt(new THREE.Vector3(0, 0, 0));
    }

    // 渲染器
    function initRenderer() {
        if (Detector.webgl) {
            renderer = new THREE.WebGLRenderer({antialias: true});
        } else {
            renderer = new THREE.CanvasRenderer();
        }
        renderer.setSize(sceneDiv.width(), sceneDiv.height());
        renderer.setClearColor(0x050505);
        sceneDiv.append(renderer.domElement);

    }

    // 初始化模型
    function initContent() {
        const helper = new THREE.GridHelper(1200, 50, 0xCD3700, 0x4A4A4A);
        scene.add(helper);

        const cubeGeometry = new THREE.BoxGeometry(100, 100, 100);
        const cubeMaterial = new THREE.MeshPhongMaterial({color: 0X808080, transparent: false});
        const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
        cube.position.x = 5000;
        cube.position.y = 50;
        cube.name = "cube";
        scene.add(cube);
        models.push(cube)


        const sphereGeometry = new THREE.SphereGeometry(50, 50, 50, 50);
        const sphereMaterial = new THREE.MeshPhongMaterial({color: 0X808080, transparent: false});
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        sphere.position.x = 5000;
        sphere.position.y = 50;
        sphere.name = "sphere";
        scene.add(sphere);
        models.push(sphere)


        const cylinderGeometry = new THREE.CylinderGeometry(50, 50, 100, 100);
        const cylinderMaterial = new THREE.MeshPhongMaterial({color: 0X808080, transparent: false});
        const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
        cylinder.position.x = 5000;
        cylinder.position.y = 50;
        cylinder.name = "cylinder";
        scene.add(cylinder);
        models.push(cylinder)


    }

    // 鼠标双击触发的方法
    function onMouseDblclick(event) {

        // 获取 raycaster 和所有模型相交的数组，其中的元素按照距离排序，越近的越靠前
        const intersects = getIntersects(event);

        // 获取选中最近的 Mesh 对象
        if (intersects.length !== 0 && intersects[0].object instanceof THREE.Mesh) {
            selectObject = intersects[0].object;
            changeMaterial(selectObject);
        } else {
            // alert("未选中 Mesh!");
        }
    }

    // 获取与射线相交的对象数组
    function getIntersects(event) {
        event.preventDefault();
        console.log("event.clientX:" + event.clientX)
        console.log("event.clientY:" + event.clientY)

        // 声明 raycaster 和 mouse 变量
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 通过鼠标点击位置,计算出 raycaster 所需点的位置,以屏幕为中心点,范围 -1 到 1
        mouse.x = (event.clientX / sceneDiv.width()) * 2 - 1;
        mouse.y = -(event.clientY / sceneDiv.height()) * 2 + 1;

        //通过鼠标点击的位置(二维坐标)和当前相机的矩阵计算出射线位置
        raycaster.setFromCamera(mouse, camera);

        // 获取与射线相交的对象数组，其中的元素按照距离排序，越近的越靠前
        const intersects = raycaster.intersectObjects(scene.children);

        //返回选中的对象
        return intersects;
    }

    // 窗口变动触发的方法
    function onWindowResize() {
        camera.aspect = sceneDiv.width() / sceneDiv.height();
        camera.updateProjectionMatrix();
        renderer.setSize(sceneDiv.width(), sceneDiv.height());
    }

    // 键盘按下触发的方法
    function onKeyDown(event) {
        switch (event.keyCode) {
            case 13:
                initCamera();
                initControls();
                break;
        }
    }

    // 改变对象材质属性
    function changeMaterial(object) {

        const material = new THREE.MeshLambertMaterial({
            color: 0xffffff * Math.random()

        });
        object.material = material;
    }

    // 初始化轨迹球控件
    function initControls() {
        controls = new THREE.TrackballControls(camera, renderer.domElement);
        controls.noRotate = true;
        controls.noPan = true;
        // 视角最小距离
        controls.minDistance = 1000;
        // 视角最远距离
        controls.maxDistance = 5000;
    }

    // 添加拖拽控件
    function initDragControls() {
        // 添加平移控件
        transformControls = new THREE.TransformControls(camera, renderer.domElement);

        scene.add(transformControls);

        // 过滤不是 Mesh 的物体,例如辅助网格
        const objects = [];
        for (let i = 0; i < scene.children.length; i++) {
            if (scene.children[i].isMesh) {
                objects.push(scene.children[i]);
            }
        }
        // 初始化拖拽控件
        dragControls = new THREE.DragControls(models, camera, renderer.domElement);

        // 鼠标略过事件
        dragControls.addEventListener('hoveron', function (event) {
            // 让变换控件对象和选中的对象绑定
            transformControls.attach(event.object);
        });
        // 开始拖拽
        dragControls.addEventListener('dragstart', function (event) {
            controls.enabled = false;
        });
        // 拖拽结束
        dragControls.addEventListener('dragend', function (event) {
            controls.enabled = true;
        });

    }

    // 初始化灯光
    function initLight() {
        light = new THREE.SpotLight(0xffffff);
        light.position.set(-300, 600, -400);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff));
    }

    // 初始化 dat.GUI
    function initGui() {

        // 用来保存我们想要通过dat.gui修改的那些变量
        var ctrls = {
            rotationSpeed: 0.02,
            bouncingSpeed: 0.03,
            bouncingHeight: 10
        }
        //初始化对象，并添加变量的取值范围
        var gui = new dat.GUI();
        gui.add(ctrls, 'rotationSpeed', 0, 0.5);
        gui.add(ctrls, 'bouncingSpeed', 0, 0.5);
        gui.add(ctrls, 'bouncingHeight', 10, 20);
        // 属性添加到控件

        scene.add(gui)
    }

    // 初始化性能插件
    function initStats() {
        const stats = new Stats();

        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '5px';
        stats.domElement.style.top = '5px';

        sceneDiv.append(stats.domElement);
        return stats;
    }

    // 更新div的位置
    function renderDiv(object) {
        // 获取窗口的一半高度和宽度
        let halfWidth = sceneDiv.width() / 2;
        let halfHeight = sceneDiv.height() / 2;

        // 逆转相机求出二维坐标
        let vector = object.position.clone().project(camera);

        // 修改 div 的位置
        $("#label").css({
            left: vector.x * halfWidth + halfWidth,
            top: -vector.y * halfHeight + halfHeight - object.position.y
        });
        // 显示模型信息
        $("#label").text("name:" + object.name);
    }

    // 更新控件
    function update() {
        stats.update();
        controls.update();
        controls.handleResize();
        transformControls.update();

        updateModeInfo()

    }

    function updateModeInfo() {
        if (model.position != null) {
            let px = model.position.x.toFixed(4)
            let py = model.position.y.toFixed(4)
            let pz = model.position.z.toFixed(5)
            $('#px').html(px)
            $('#py').html(py)
            $('#pz').html(pz)
        }
        if (model.rotation != null) {
            let rx = model.rotation.x.toFixed(4)
            let ry = model.rotation.y.toFixed(4)
            let rz = model.rotation.z.toFixed(4)
            $('#rx').html(rx)
            $('#ry').html(ry)
            $('#rz').html(rz)
        }
        if (model.scale != null) {
            let sx = model.scale.x.toFixed(4)
            let sy = model.scale.y.toFixed(4)
            let sz = model.scale.z.toFixed(4)
            $('#sx').html(sx)
            $('#sy').html(sy)
            $('#sz').html(sz)
        }
    }


    // 初始化
    function init() {
        initScene();
        initCamera();
        initRenderer();
        initContent();
        initLight();
        initControls();
        initGui();
        initDragControls();
        addEventListener('dblclick', onMouseDblclick, false);
        addEventListener('resize', onWindowResize, false);
        addEventListener('keydown', onKeyDown, false);

    }

    function animate() {
        if (selectObject != undefined && selectObject != null) {
            renderDiv(selectObject);
        }
        if (tr) {
            if (model.position !== undefined && model.position !== null) {
                model.position.x += 1
            }
        }
        if (ro) {
            if (model.rotation !== undefined && model.rotation !== null) {
                model.rotation.x += 0.01
            }
        }
        if (sc) {
            if (model.scale !== undefined && model.scale !== null) {
                model.scale.x += 0.001
                model.scale.y += 0.001
                model.scale.z += 0.001
            }
        }

        requestAnimationFrame(animate);
        renderer.render(scene, camera);
        update();
    }

    init();
    animate();

    function stop(){
        tr = false;
        ro = false;
        sc = false;

    }

    function transformOnClick(i) {
        if (i === 1) {
            transformControls.setMode('translate');
            $('#iframe').attr('src', 'img.html#py')
            tr = true

        }
        if (i === 2) {
            transformControls.setMode('rotate');
            $('#iframe').attr('src', 'img.html#xz')
            ro = true
        }
        if (i === 3) {
            transformControls.setMode('scale')
            $('#iframe').attr('src', 'img.html#sf')
            sc = true
        }
        setTimeout(stop,1000)
    }

    function addModelOnClick(i) {
        for (let j = 0; j < models.length; j++) {
            if (i === j) {
                model = models[j]
                model.position.x = 0;
            } else {
                models[j].position.x = 5000;
            }
        }
    }

    function sendMsg() {
        const text = $('#pltext').val().trim();
        if (text == null) {
            alert("请输入内容")
        }
        const date = format(new Date(), 'HH:mm:ss');
        const data = {}
        data.uid = user.id
        data.text = text;
        data.date = date
        data.name = user.name
        $.ajax({
            url: '/user/send',
            data: JSON.stringify(data),
            contentType: "application/json",
            type: "POST",
            success: function (result) {
                let code = result.code;
                if (code === 200) {
                    $('#messages').append("<div class=\"message-item outgoing-message\">" +
                        "<div class=\"message-header\">" +
                        user.name
                        + "</div><div class=\"message-content\">" +
                        text
                        + "</div><div class=\"message-action\">" +
                        format(new Date(), 'HH:mm:ss')
                        + "</div></div>");
                    document.getElementById('msg_end').scrollIntoView(false);
                    return;
                }
                alert(result.msg)
            },
            error: function (result) {
                alert("服务器忙，请稍后")
            }
        });
    }

    function getMsg() {
        $.ajax({
            url: '/user/getMsg',
            data: {},
            contentType: "application/json",
            type: "GET",
            success: function (result) {
                let code = result.code;
                if (code === 200) {
                    msgList = result.data;
                    output(msgList)
                    return;
                }
                // alert(result.msg)
            },
            error: function (result) {
                // alert("服务器忙，请稍后")
            }
        });
    }

    function output(msgList) {
        $('#messages').html('');
        msgList.forEach(function (msg) {
            let isme = '';
            if (msg.uid === user.id) {
                isme = 'outgoing-message'
            }

            $('#messages').append("<div class=\"message-item " + isme + "\">" +
                "<div class=\"message-header\">" +
                msg.name
                + "</div><div class=\"message-content\">" +
                msg.text
                + "</div><div class=\"message-action\">" +
                msg.date
                + "</div></div>");
            document.getElementById('msg_end').scrollIntoView(false);
        })
    }

    /**
     * 获取年月日 时分秒
     * @param {string | number} time 时间字符串 | 时间戳
     * @returns { year, month, date, hours, minutes, seconds }
     */
    function getDate(time) {
        const date = new Date(time)
        const y = date.getFullYear()
        const M = date.getMonth() + 1
        const MM = M > 9 ? M : '0' + M
        const d = date.getDate()
        const dd = d > 9 ? d : '0' + d
        const H = date.getHours()
        const HH = H > 9 ? H : '0' + H
        const m = date.getMinutes()
        const mm = m > 9 ? m : '0' + m
        const s = date.getSeconds()
        const ss = s > 9 ? s : '0' + s

        const t = date.toLocaleTimeString()
        const t_1 = t.substr(0, 2)
        const t_2 = t.slice(2)
        const h = t_2.split(':')[0]
        const hh = h > 9 ? h : '0' + h
        const a_p = t_1 === '上午' ? 'am' : 'pm'

        return {y, M, MM, d, dd, H, HH, m, mm, s, ss, h, hh, a_p}
    }

    /**
     * 格式化时间类型
     * @param {string | number} time 时间字符串 | 时间戳
     * @param {string} type 时间格式
     * @returns 格式化后时间字符串
     */
    function format(time, type) {
        if (time !== null && !time)
            throw('format error: params 1 time is required')
        if (new Date(time) == 'Invalid Date')
            throw('time error: params 1 time is Invalid Date')
        if (type && typeof type !== 'string')
            throw('format error: params 2 type not is a string')

        const {y, M, MM, d, dd, H, HH, m, mm, s, ss, h, hh, a_p} = getDate(time)

        switch (type) {
            case 'yyyy-MM-dd':
                return [y, MM, dd].join('-')
            case 'yyyy-M-d':
                return [y, M, d].join('-')
            case 'HH:mm:ss':
                return [HH, mm, ss].join(':')
            case 'H:m:s':
                return [H, m, s].join(':')
            case 'h:m:s':
                return [h, m, s].join(':') + ' ' + a_p
            case 'yyyy-MM-dd HH:mm:ss':
                return [y, MM, dd].join('-') + ' ' + [HH, mm, ss].join(':')
            case 'yyyy-M-d H:m:s':
                return [y, M, d].join('-') + ' ' + [H, m, s].join(':')
            default:
                return [y, MM, dd].join('-')
        }
    }


</script>
</body>
</html>